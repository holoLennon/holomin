appctrl.controller("tabCtrl",function(e,t,n,i,o,r,a,u,c,s,l,f,p,d,g,m,b,C,h){n.debug("enter tab ctrl2");e.rolemem=505;e.user={};e.tab="sms";e.countdown=0;e.meuser=g.get(LOGINED_USER_B);if(!e.meuser)e.meuser={};e.memberDoctorWatching={};e.$on("$ionicView.beforeEnter",function(){n.debug("tab ctrl beforeEnter")});e.$on("$ionicView.afterEnter",function(){n.debug("tab ctrl afterEnter")});e.init=function(){n.debug("tab ctrl init")};e.$on("event.NeedLoginException",function(t,i){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}n.debug("收到通知：event.NeedLoginException,data="+i);if(i==="reg"){e.user=g.get(REG_USER);e.user.password="";e.user.rememberpwd=true;e.user.autologin=true}else{e.user=g.get(LOGINED_USER_B);if(e.user==null||e.user==="")e.user={}}e.openPopLogin()});e.$on("event.NeedWxpayWindow",function(t,i){n.debug("收到通知：event.NeedWxpayWindow,data="+JSON.stringify(i));e.openPopWxpay();if(_ClientInfo.cli==3){var o=i.obj["WaJsapiPaymentParam"];console.log("by cashticketMember");C.config().then(function(e){console.log("WxService config then ");C.pay(o).then(function(e){})})}if(_ClientInfo.cli===1){var r=i.obj["WaAppapiPaymentParam"];wxpay.pay(r,function(){},function(){})}if(_ClientInfo.cli===2){}if(_ClientInfo.cli==null||_ClientInfo.cli===3){}});e.$on("event.NeedAlipayWindow",function(t,i){n.debug("收到通知：event.NeedAlipayWindow,data="+JSON.stringify(i));e.openPopApay();if(_ClientInfo.cli===1){}if(_ClientInfo.cli===2){}});e.$on("event.alertm",function(e,t){n.debug("收到通知：event.alertm,data="+t);d.alertm(t).then(function(e){})});e.tabChange=function(t){e.tab=t};e.requestCode=function(t){n.debug("请求验证码");n.debug(t);var i=/^0?1[0-9]{10}$/;if(!i.test(t.mobile)){d.alertm("手机号无效");return}b.requestCode(t.mobile).then(function(){d.alertm("验证码已发送");e.count(60)})};e.count=function(t){e.countdown=t;if(t!=0){i(function(){e.count(t-1)},1e3)}};e.dologinbysms=function(i){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}i.roleId=6;n.debug("短信验证登陆");b.dologinbysms(i).then(function(n){e.popLogin.hide();var i=_.clone(e.user);e.user=n;e.user.passwordmd5=e.user.password;g.set(LOGINED_USER_B,e.user);var o=g.get(CLIENT_INFO);if(!o){o=_.clone(_ClientInfo)}o.token=e.user.token;g.set(CLIENT_INFO,o);l.goBack();t.$broadcast("event.logined")})};e.dologin=function(n){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}e.user=n;n.roleId=6;n.isauto=0;console.log(n);m.dologin(n).then(function(n){e.popLogin.hide();var i=_.clone(e.user);e.user=n;e.user.passwordmd5=e.user.password;e.user.password=i.password;g.set(LOGINED_USER_B,e.user);var o=g.get(CLIENT_INFO);if(!o){o=_.clone(_ClientInfo)}o.token=e.user.token;g.set(CLIENT_INFO,o);e.meuser=g.get(LOGINED_USER_B);l.goBack();t.$broadcast("event.logined")})};e.closePopLogin=function(t){n.debug("closePopLogin");e.popLogin.hide();l.goBack()};r.fromTemplateUrl("views/pub/login.html",{scope:e}).then(function(t){e.popLogin=t});e.openPopLogin=function(t){e.popLogin.show(t)};e.popWxpay={};r.fromTemplateUrl("views/pub/wxpay.html",{scope:e}).then(function(t){e.popWxpay=t});e.openPopWxpay=function(t){e.popWxpay.show(t)};e.popApay={};r.fromTemplateUrl("views/pub/apay.html",{scope:e}).then(function(t){e.popApay=t});e.openPopApay=function(t){e.popApay.show(t)};e.nowtabs=function(t){n.debug("当前的tab="+t);pubnowtab=t;if("B"===t){e.jumpPage("MemberDoctorList")}else if("C"===t){e.jumpPage("fuwu")}else if("D"===t){e.jumpPage("my")}else{e.jumpPage("ProductTypeLinkProductListHome")}};e.getHalfHeight=function(){return 300};e.rx=function(t){t="R"+pubnowtab+"_"+t.substring(6);e.jumpPage(t)};e.jumpPage=function(e){c.path("/tab/"+e)};e.ctrlMapPut=function(e){ctrlReinitMap.put(e,1)};e.goBack=function(){if(l.backView()){l.goBack()}};e.listCart=[];e.cartPrice=0;e.$on("refereshCartNum",function(t,n){e.initCartNum()});e.initCartNum=function(){n.debug("tabs initCartNum");e.listCart=g.get(LISTCART);var t=0;angular.forEach(e.listCart,function(e){t+=e.num});e.cartTNum=t};e.cartNum=function(t){var n=e.cartFind(t.id);if(n)return n.num;return 0};e.cartSaveLocal=function(){g.set(LISTCART,e.listCart)};e.cartAdd=function(t){var n=e.cartFind(t.id);if(!n)n=e.cartCreate(t.id);e.memberDoctorWatching=g.get(MEMBER_DOCTOR_WATCHING);n.productId=t.id;n.memberId=e.memberDoctorWatching.id;n.img1=t.img1;n.title=t.title;n.price=t.price;n.usemount=t.usemount;n.usemethord=t.statusUsedString;n.num+=1;n.obj1=t;g.set(LISTCART,e.listCart);e.refereshPrice()};e.cartRemove=function(t){var n=e.cartFind(t.id);if(!n)return;if(n.num>1){n.num-=1;g.set(LISTCART,e.listCart);e.refereshPrice()}else{e.cartDel(t.id)}};e.cartFind=function(t){for(var n=0;n<e.listCart.length;n++){if(e.listCart[n].productId===t)return e.listCart[n]}return null};e.cartCreate=function(t){var n=_.clone(_Orderrdetail);n.productId=t;n.num=0;e.listCart.push(n);return n};e.cartDel=function(t){d.confirm("是否确认将该商品从购物车移除?").then(function(n){if(n){var i=e.cartFindIndex(t);if(i>-1){e.listCart.remove(i)}g.set(LISTCART,e.listCart);if(e.listCart.length==0){e.listCart=null}e.refereshPrice()}else{}})};e.cartFindIndex=function(t){for(var n=0;n<e.listCart.length;n++){if(e.listCart[n].productId===t)return n}return-1};e.refereshPrice=function(){e.cartPrice=0;if(e.listCart!=null&&e.listCart.length>0){for(var t=0;t<e.listCart.length;t++){e.cartPrice+=e.listCart[t].obj1.price*e.listCart[t].num}}e.$emit("refereshCartNum","aaa")};e.init()});