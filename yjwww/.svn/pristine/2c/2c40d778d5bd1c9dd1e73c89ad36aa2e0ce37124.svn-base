appctrl.controller("tabCtrl",function(t,e,n,i,r,o,a,u,c,l,s,f,p,d,g,C,m,b,h){n.debug("enter tab ctrl");t.rolemem=303;t.user={};t.listCart=[];t.cartPrice=0;t.tab="sms";t.countdown=0;t.meuser=g.get(LOGINED_USER);if(!t.meuser)t.meuser={};t.$on("$ionicView.beforeEnter",function(){n.debug("tab ctrl beforeEnter")});t.$on("$ionicView.afterEnter",function(){n.debug("tab ctrl afterEnter");if(ctrlReinitMap.get("tabCtrl")){ctrlReinitMap.remove("tabCtrl");n.debug("tab ctrl afterEnter init");t.init()}});t.$on("event.NeedLoginException",function(e,i){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}n.debug("收到通知：event.NeedLoginException,data="+i);if(i==="reg"){t.user=g.get(REG_USER);t.user.password="";t.user.rememberpwd=true;t.user.autologin=true}else{t.user=g.get(LOGINED_USER);if(t.user==null||t.user==="")t.user={}}t.openPopLogin()});t.$on("event.NeedWxpayWindow",function(e,i){n.debug("收到通知：event.NeedWxpayWindow,data="+JSON.stringify(i));t.openPopWxpay();if(_ClientInfo.cli==3){var r=i.obj["WaJsapiPaymentParam"];console.log("by cashticketMember");b.config().then(function(t){console.log("WxService config then ");b.pay(r).then(function(t){})})}if(_ClientInfo.cli===1){var o=i.obj["WaAppapiPaymentParam"];wxpay.pay(o,function(){},function(){})}if(_ClientInfo.cli===2){}if(_ClientInfo.cli==null||_ClientInfo.cli===3){}});t.$on("event.NeedAlipayWindow",function(e,i){n.debug("收到通知：event.NeedAlipayWindow,data="+JSON.stringify(i));t.openPopApay();if(_ClientInfo.cli===1){}if(_ClientInfo.cli===2){}});t.$on("event.alertm",function(t,e){n.debug("收到通知：event.alertm,data="+e);d.alertm(e).then(function(t){})});t.$on("refereshCartNum",function(e,n){t.initCartNum()});t.init=function(){n.debug("tab ctrl init");t.listCart=g.get(LISTCART);if(!t.listCart)t.listCart=[]};t.nowtabs=function(e){n.debug("当前的tab="+e);pubnowtab=e;if("B"===e){t.jumpPage("ProductType2/mclass")}else if("C"===e){t.jumpPage("Cart")}else if("D"===e){t.jumpPage("my")}else{t.jumpPage("Wwwhome")}};t.getHalfHeight=function(){return 300};t.rx=function(e){e="R"+pubnowtab+"_"+e.substring(6);t.jumpPage(e)};t.jumpPage=function(t){c.path("/tab/"+t)};t.ctrlMapPut=function(t){ctrlReinitMap.put(t,1)};t.goBack=function(){if(s.backView()){s.goBack()}};t.tabChange=function(e){t.tab=e};t.requestCode=function(e){n.debug("请求验证码");n.debug(e);if(!checkPhoneNum(e.username)){d.alertm("手机号无效");return}m.requestCode(e.username).then(function(){d.alertm("验证码已发送");t.count(60)})};t.count=function(e){t.countdown=e;if(e!=0){i(function(){t.count(e-1)},1e3)}};t.dologinbysms=function(i){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}i.roleId=5;n.debug("短信验证登陆");m.dologinbysms(i).then(function(n){t.popLogin.hide();var i=_.clone(t.user);t.user=n;t.user.passwordmd5=t.user.password;g.set(LOGINED_USER,t.user);var r=g.get(CLIENT_INFO);if(!r){r=_.clone(_ClientInfo)}r.token=t.user.token;g.set(CLIENT_INFO,r);t.meuser=g.get(LOGINED_USER);c.path("/tab/Editmember");e.$broadcast("event.logined")})};t.dologin=function(n){if(wxNoOpenid()){window.location.href=outGetOpenidUrl;return}t.user=n;n.roleId=5;n.isauto=0;console.log(n);C.dologin(n).then(function(n){t.popLogin.hide();var i=_.clone(t.user);if(!n||!n.password){d.alertm("账密错误，登录失败，请重试");return}t.user=n;t.user.passwordmd5=t.user.password;t.user.password=i.password;g.set(LOGINED_USER,t.user);var r=g.get(CLIENT_INFO);if(!r){r=_.clone(_ClientInfo)}r.token=t.user.token;g.set(CLIENT_INFO,r);t.meuser=g.get(LOGINED_USER);s.goBack();e.$broadcast("event.logined")})};t.popLogin={};o.fromTemplateUrl("views/pub/login.html",{scope:t}).then(function(e){t.popLogin=e});t.openPopLogin=function(e){t.popLogin.show(e)};t.closePopLogin=function(e){n.debug("closePopLogin");t.popLogin.hide();s.goBack()};t.popWxpay={};o.fromTemplateUrl("views/pub/wxpay.html",{scope:t}).then(function(e){t.popWxpay=e});t.openPopWxpay=function(e){t.popWxpay.show(e)};t.popApay={};o.fromTemplateUrl("views/pub/apay.html",{scope:t}).then(function(e){t.popApay=e});t.openPopApay=function(e){t.popApay.show(e)};t.checkCart=function(){n.debug("tabs check Cart");t.listCart=g.get(LISTCART);var e=false;angular.forEach(t.listCart,function(t){if(!t.obj1)e=true});if(e){t.listCart=[];g.remove(LISTCART)}};t.initCartNum=function(){n.debug("tabs initCartNum");t.listCart=g.get(LISTCART);if(!t.listCart)t.listCart=[];var e=0;angular.forEach(t.listCart,function(t){e+=t.num});t.cartTNum=e};t.cartNum=function(e){var n=t.cartFind(e.id);if(n)return n.num;return 0};t.cartAdd=function(e){var n=t.cartFind(e.id);if(!n)n=t.cartCreate(e.id);n.price=e.price;n.num+=1;n.obj1=e;g.set(LISTCART,t.listCart);t.refereshPrice()};t.cartRemove=function(e){var n=t.cartFind(e.id);if(!n)return;if(n.num>1){n.num-=1;g.set(LISTCART,t.listCart);t.refereshPrice()}else{t.cartDel(e.id)}};t.cartFind=function(e){if(!t.listCart)t.listCart=[];for(var n=0;n<t.listCart.length;n++){if(t.listCart[n].productId===e)return t.listCart[n]}return null};t.cartCreate=function(e){var n=_.clone(_Cart);n.productId=e;n.num=0;if(!t.listCart)t.listCart=[];t.listCart.push(n);return n};t.cartDel=function(e){d.confirm("是否确认将该商品从购物车移除?").then(function(n){if(n){var i=t.cartFindIndex(e);if(i>-1){t.listCart.remove(i)}g.set(LISTCART,t.listCart);if(t.listCart.length==0){t.listCart=null}t.refereshPrice()}else{}})};t.cartFindIndex=function(e){for(var n=0;n<t.listCart.length;n++){if(t.listCart[n].productId===e)return n}return-1};t.refereshPrice=function(){t.cartPrice=0;if(t.listCart!=null&&t.listCart.length>0){for(var e=0;e<t.listCart.length;e++){t.cartPrice+=t.listCart[e].obj1.price*t.listCart[e].num}t.cartPrice=t.cartPrice.toFixed(2)}t.$emit("refereshCartNum","aaa")};t.init();ctrlReinitMap.remove("tabCtrl")});