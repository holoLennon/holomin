appctrl.controller("DmmsgListCtrl",function(e,t,n,r,o,i,s,a,l,u,c,g,m,d,f,p,h,b,j,v,w){d.debug("enter DmmsgList ctrl");var D=u.fromto;var y=u.memberId;var L=u.doctorId;var C={};var $="http://yijian.zjjnyd.com/yijian/rest";e.page=_.clone(_Page);e.list=[];e.obj={};e.scrollBottom=function(){c.scrollBottom()};e.$on("$ionicView.beforeEnter",function(){d.debug("DmmsgList ctrl beforeEnter")});e.$on("$ionicView.afterEnter",function(){d.debug("DmmsgList ctrl afterEnter");if(ctrlReinitMap.get("DmmsgListCtrl")){ctrlReinitMap.remove("DmmsgListCtrl");d.debug("DmmsgList ctrl afterEnter init");e.init()}});e.$on("$destroy",function(){d.debug("DmmsgList ctrl $destroy");f.cancel(C)});e.eachMsg=function(){d.debug("DmmsgList newmsg ");if(e.list.length==0){d.debug("newmsg $scope.list.length==0 ");return}var t=e.list[e.list.length-1].gmtCreateString;var n=_.clone(_Page);n.where="gmtCreate > '"+t+"' and memberId="+y+" and doctorId="+L;n.pageNo=1;b.first(null,n).then(function(t){d.debug("DmmsgList ctrl newmsg then");if(t&&t.length>0){e.addList(t);e.scrollBottom()}})};e.init=function(){d.debug("DmmsgList ctrl init ");e.page.where="memberId="+y+" and doctorId="+L;e.page.pageNo=1;e.page.hasNextPage=false;e.list=[];e.first();e.newDmmsg();C=f(e.eachMsg,5e3)};e.addList=function(t){angular.forEach(t,function(t){e.list.push(t);if(e.obj1==null){e.obj1=t}});if(t&&t.length<e.page.pageSize){e.page.hasNextPage=false}else{e.page.hasNextPage=true}};e.first=function(){b.first(null,e.page).then(function(t){d.debug("DmmsgList ctrl query then");e.addList(t);e.list=_.sortBy(e.list,function(e){return e.gmtCreateString});e.scrollBottom();e.$broadcast("scroll.refreshComplete")})};e.newDmmsg=function(){e.obj=_.clone(_Dmmsg);e.obj.fromto=D;e.obj.memberId=y;e.obj.doctorId=L};e.save=function(){d.debug(e.obj);if(e.obj.msg==null){return}b.create(e.obj).then(function(t){d.debug("Dmmsg ctrl save then");e.list.push(t);e.scrollBottom();e.newDmmsg()})};e.upload=function(t,n){e.errorMsg=null;I(t,n)};function I(t,r){t.upload=v.upload({url:$+"/upload"+e.getReqParams(),resumeSizeUrl:r?$+"/upload?name="+encodeURIComponent(t.name):null,resumeChunkSize:r?e.chunkSize:null,headers:{"optional-header":"header-value"},data:{username:e.username},file:t}).progress(function(t){e.progressPercentage=parseInt(100*t.loaded/t.total);d.debug("progess:"+e.progressPercentage+"%"+t.config.file.name)}).success(function(t){angular.forEach(t.result,function(t){if(t.fieldName=="url"){d.debug(t.value);if(t.value!=null){var n="http://yijian.zjjnyd.com/yijian"+t.value;e.obj.msg="<a href='"+n+"'><img class='imgthumbs' style='max-width:100%;max-height:100%;' src='"+n+"'></a>";d.debug(e.obj.msg);e.save()}}})});t.upload.then(function(e){n(function(){t.result=e.data})},function(t){if(t.status>0)e.errorMsg=t.status+": "+t.data},function(e){t.progress=Math.min(100,parseInt(100*e.loaded/e.total))});t.upload.xhr(function(e){})}e.$watch("files",function(t){if(t!=null){if(!angular.isArray(t)){n(function(){e.files=t=[t]});return}for(var r=0;r<t.length;r++){v.imageDimensions(t[r]).then(function(t){e.d=t;console.log(t)});e.errorMsg=null;(function(t){e.upload(t,true)})(t[r])}}});e.isResumeSupported=v.isResumeSupported();e.chunkSize=1e5;e.success_action_redirect=e.success_action_redirect||window.location.protocol+"//"+window.location.host;e.jsonPolicy=e.jsonPolicy||'{\n  "expiration": "2020-01-01T00:00:00Z",\n  "conditions": [\n    {"bucket": "angular-file-upload"},\n    ["starts-with", "$key", ""],\n    {"acl": "private"},\n    ["starts-with", "$Content-Type", ""],\n    ["starts-with", "$filename", ""],\n    ["content-length-range", 0, 524288000]\n  ]\n}';e.acl=e.acl||"private";e.getReqParams=function(){return e.generateErrorOnServer?"?errorCode="+e.serverErrorCode+"&errorMessage="+e.serverErrorMsg:""};e.modelOptionsObj={};e.init();ctrlReinitMap.remove("DmmsgListCtrl")});